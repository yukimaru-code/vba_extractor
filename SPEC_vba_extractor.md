# vbaEXTRACTOR.py 仕様書

## 1. 目的
Excelファイル（`.xlsm` / `.xlsb` / `.xls`）からVBAマクロを抽出し、テキストファイルとして保存する。

## 2. 対象ファイル
- メインスクリプト: `vbaEXTRACTOR.py`
- 依存定義: `requirements.txt`

## 3. 動作環境・依存ライブラリ
- Python 3.x
- `oletools`（`olevba` を利用）
- `tkinter`（標準ライブラリ）
- `tkinterdnd2`（任意。利用可能時はドラッグ&ドロップUIを有効化）

## 4. 入出力仕様

### 4.1 入力
- Excelファイルパス（GUIで選択またはドラッグ&ドロップ）
- 対応拡張子: `.xlsm`, `.xlsb`, `.xls`

### 4.2 出力
- 抽出されたVBAコードを `.txt` として保存
- 保存先: 入力Excelと同じディレクトリ配下の `<Excelファイル名>/`
- 例: `sample.xlsm` -> `sample/Module1.txt`

## 5. 処理フロー
1. GUI起動時に `tkinterdnd2` の利用可否を判定する。
1. 利用可能ならドラッグ&ドロップ対応ウィンドウを表示、不可ならファイル選択ダイアログにフォールバックする。
1. ファイルパスを受け取り、存在チェックを行う。
1. マクロ保存が必要になったタイミングで出力フォルダ（Excelファイル名と同名）を作成する。
1. `VBA_Parser.detect_vba_macros()` でマクロ有無を判定する。
1. `extract_macros()` の各要素を `.txt` として保存する。
1. 成功・失敗メッセージをポップアップ表示する。

## 6. 関数仕様

### 6.1 `sanitize_filename(name, default_name="module", max_length=120)`
- 目的: Windowsで安全なファイル名に正規化する。
- 主な仕様:
  - 禁止文字（`<>:"/\\|?*` と制御文字）を `_` に置換
  - 末尾の空白/ピリオドを除去
  - 空文字の場合は `default_name` を採用
  - 予約名（`CON`, `PRN`, `AUX`, `NUL`, `COM1`-`COM9`, `LPT1`-`LPT9`）を回避
  - 最大長を `max_length`（既定120）に制限

### 6.2 `build_unique_save_path(output_dir, raw_name, used_names)`
- 目的: 出力ファイル名の重複を回避する。
- 主な仕様:
  - 正規化済みファイル名をベースに生成
  - 同名がある場合は `_1`, `_2`, ... を付与
  - 重複判定は大文字小文字を区別しない
  - 戻り値は `<output_dir>/<name>.txt`

### 6.3 `is_supported_excel_file(file_path)`
- 目的: 入力ファイルの存在と拡張子をチェックする。
- 判定条件: 実ファイルであり、拡張子が `.xlsm/.xlsb/.xls` のいずれか。

### 6.4 `parse_dnd_file_paths(root, data)`
- 目的: ドラッグ&ドロップの受信データをファイルパス配列へ変換する。
- 主な仕様:
  - Tcl list形式を `root.tk.splitlist()` で分解
  - スペースを含むパスや中括弧付きパスに対応

### 6.5 `extract_vba_from_excel(file_path)`
- 目的: VBA抽出の本処理を実行する。
- 戻り値: `(success: bool, message: str)`
- 成功時:
  - 抽出件数と保存先をメッセージとして返す
- 失敗時:
  - ファイル未存在、マクロ未検出、例外発生時の理由をメッセージで返す
  - マクロ未検出時は「暗号化・保護・破損の可能性」を含めた案内を返す
  - `VBA_Parser` は `finally` で必ず `close()` する

### 6.6 `main()`
- 目的: GUI制御とユーザー操作を受け付ける。
- 主な仕様:
  - D&D UI利用可なら専用画面を表示
  - D&D不可ならファイル選択ダイアログで処理
  - 結果は `messagebox.showinfo/showerror` で通知

## 7. UI仕様

### 7.1 D&D利用可能時
- ウィンドウタイトル: `VBA Extractor`
- 固定サイズ: `520x220`
- 構成:
  - 説明ラベル（ドラッグ&ドロップ案内）
  - ドロップ領域（`Drop Here`）
  - 対応拡張子ヒント
  - `ファイル選択...` ボタン（手動選択）

### 7.2 フォールバック時
- ファイル選択ダイアログのみを表示

## 8. エラー・例外仕様
- ファイル未存在: エラーメッセージを返却し、エラーポップアップ表示
- ドロップデータ不正: 「ドロップされたパスを取得できませんでした。」
- 非対応拡張子/ファイル不存在: 「対応していないファイル形式、またはファイルが存在しません。」
- マクロ未検出: 「マクロなし / 暗号化・保護・破損の可能性」を通知
- その他例外: 「暗号化・保護・破損の可能性」＋詳細メッセージを通知

## 9. 既知の制約
- 抽出可否は対象ファイルの状態（暗号化、破損、形式差異）や `oletools` の対応状況に依存する。
- VBAコードは `.txt` で保存され、モジュール種別ごとの拡張子分岐はしない。
- 複数ファイルを同時ドロップした場合、対応拡張子かつ実在するファイルを順次処理する。

## 10. 実行方法
```bash
pip install -r requirements.txt
python vbaEXTRACTOR.py
```
